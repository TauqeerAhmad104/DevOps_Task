{{- if .Values.backup.enabled }}
apiVersion: batch/v1
kind: CronJob
metadata:
  name: mysql-backup
  namespace: {{ .Release.Namespace }}
spec:
  schedule: "{{ .Values.backup.schedule }}"
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          containers:
            - name: mysql-backup
              image: mysql:8.0
              env:
                - name: MYSQL_PWD
                  valueFrom:
                    secretKeyRef:
                      name: mysql-root-secret
                      key: password
              command: ["/bin/sh", "-c"]
              args:
                - |
                  # wait for MySQL to be reachable before dumping
                  for i in $(seq 1 30); do
                    mysqladmin ping -h mysql -uroot || sleep 2
                    if [ $? -eq 0 ]; then break; fi
                  done
                  mysqldump -h mysql -u root --all-databases > /backups/backup-$(date +%Y%m%d-%H%M%S).sql
              volumeMounts:
                - name: backup-vol
                  mountPath: /backups
          volumes:
            - name: backup-vol
              persistentVolumeClaim:
                claimName: {{ .Values.backup.pvc.name }}
{{- end }}
