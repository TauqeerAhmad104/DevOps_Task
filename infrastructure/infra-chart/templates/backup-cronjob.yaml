{{- if .Values.backup.enabled }}
apiVersion: batch/v1
kind: CronJob
metadata:
  name: mysql-backup
  namespace: infrastructure
spec:
  schedule: "{{ .Values.backup.schedule }}"
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          containers:
            - name: mysql-backup
              image: mysql:8.0
              env:
                - name: MYSQL_PWD
                  valueFrom:
                    secretKeyRef:
                      name: mysql-root-secret
                      key: password
              command: ["/bin/sh", "-c"]
              args:
                - |
                  echo "Starting MySQL backup..."
                  BACKUP_FILE="/backups/backup-$(date +%Y%m%d-%H%M%S).sql"
                  mysqldump -h mysql.infrastructure.svc.cluster.local -u root --all-databases > "$BACKUP_FILE"
                  
                  echo "Cleaning old backups (keep 5 latest)..."
                  ls -tp /backups/backup-*.sql | tail -n +6 | xargs -r rm -- 2>/dev/null || true
                  
                  echo "Copying latest backup to local path..."
                  mkdir -p {{ .Values.backup.localPath }}
                  cp -f "$BACKUP_FILE" {{ .Values.backup.localPath }}/
                  
                  echo "Backup completed successfully."
              volumeMounts:
                - name: backup-vol
                  mountPath: /backups
                - name: local-copy
                  mountPath: {{ .Values.backup.localPath }}
          volumes:
            - name: backup-vol
              persistentVolumeClaim:
                claimName: {{ .Values.backup.pvc.name }}
            - name: local-copy
              hostPath:
                path: {{ .Values.backup.localPath }}
{{- end }}
